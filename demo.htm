<!DOCTYPE html>
<html>
        <head>
            <link rel="icon" href="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pg0KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDE5LjAuMCwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPg0KPHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJMYXllcl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCINCgkgdmlld0JveD0iMCAwIDUxMiA1MTIiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDUxMiA1MTI7IiB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxnPg0KCTxwYXRoIHN0eWxlPSJmaWxsOiM3NkNGRTI7IiBkPSJNMTAuMTk5LDI4OC41ODNjMC00Mi44NjksMzQuNzUyLTc3LjYyMSw3Ny42MjEtNzcuNjIxczc3LjYyMSwzNC43NTIsNzcuNjIxLDc3LjYyMUgxMC4xOTl6Ii8+DQoJPHBhdGggc3R5bGU9ImZpbGw6Izc2Q0ZFMjsiIGQ9Ik0zNDYuNTU4LDI4OC41ODNjMC00Mi44NjksMzQuNzUyLTc3LjYyMSw3Ny42MjEtNzcuNjIxczc3LjYyMiwzNC43NTMsNzcuNjIyLDc3LjYyMUgzNDYuNTU4eiIvPg0KCTxwYXRoIHN0eWxlPSJmaWxsOiM3NkNGRTI7IiBkPSJNMjU5LjEwNSwzODkuOTc1YzMwLjMxMy0zMC4zMTMsNzkuNDYtMzAuMzEzLDEwOS43NzMsMGMzMC4zMTMsMzAuMzEzLDMwLjMxMyw3OS40NiwwLDEwOS43NzMNCgkJTDI1OS4xMDUsMzg5Ljk3NXoiLz4NCgk8cGF0aCBzdHlsZT0iZmlsbDojNzZDRkUyOyIgZD0iTTI1NC45OTksMzg5Ljk3NWMtMzAuMzEzLTMwLjMxMy03OS40Ni0zMC4zMTMtMTA5Ljc3MywwYy0zMC4zMTMsMzAuMzEzLTMwLjMxMyw3OS40NiwwLDEwOS43NzMNCgkJTDI1NC45OTksMzg5Ljk3NXoiLz4NCgk8cGF0aCBzdHlsZT0iZmlsbDojNzZDRkUyOyIgZD0iTTMwNy43NDgsMTc0LjczOUgyMDQuMjUyVjY0YzAtMjguNTc5LDIzLjE2OS01MS43NDgsNTEuNzQ4LTUxLjc0OGwwLDANCgkJYzI4LjU3OSwwLDUxLjc0OCwyMy4xNjksNTEuNzQ4LDUxLjc0OFYxNzQuNzM5eiIvPg0KPC9nPg0KPGNpcmNsZSBzdHlsZT0iZmlsbDojRkY5MzFFOyIgY3g9IjI1NiIgY3k9IjI3Ny4yMDQiIHI9IjE3MC4yNDUiLz4NCjxwb2x5Z29uIHN0eWxlPSJmaWxsOiNGMTVBMjQ7IiBwb2ludHM9IjE3NC4yNDUsMjI5Ljk5OCAyNTYsMTgyLjc5NyAzMzcuNzU1LDIyOS45OTggMzM3Ljc1NSwzMjQuNCAyNTYsMzcxLjYwMiAxNzQuMjQ1LDMyNC40ICIvPg0KPHBhdGggZD0iTTQyNC4xOCwyMDAuNzYzYy0xLjU1OCwwLTMuMTI0LDAuMDQzLTQuNjg1LDAuMTI1Yy0yMC4xMjktNDIuOTU0LTU2LjY4OC03Ni43MzYtMTAxLjU0Ni05My4xODJWNjQNCgljMC0zNC4xNTctMjcuNzktNjEuOTQ3LTYxLjk0Ny02MS45NDdTMTk0LjA1NCwyOS44NDMsMTk0LjA1NCw2NHY0My43MDdjLTQ0Ljg2LDE2LjQ0Ny04MS40MTksNTAuMjMxLTEwMS41NDgsOTMuMTg2DQoJYy0xLjU2LTAuMDgzLTMuMTI1LTAuMTI5LTQuNjg0LTAuMTI5QzM5LjM5NiwyMDAuNzYzLDAsMjQwLjE2LDAsMjg4LjU4M2MwLDUuNjMzLDQuNTY2LDEwLjE5OSwxMC4xOTksMTAuMTk5aDY2LjY0OA0KCWM0LjY3OCwzOS4wNzEsMjEuODg5LDc0LjM0LDQ3LjQ4NiwxMDEuNjY5Yy05LjAxOCwxNS4zODctMTMuMTc2LDMzLjMxOS0xMS43NzMsNTEuMjg0YzEuNjI2LDIwLjgyNCwxMC42NjYsNDAuNDM2LDI1LjQ1NCw1NS4yMjUNCgljMS45OTIsMS45OTIsNC42MDIsMi45ODcsNy4yMTIsMi45ODdzNS4yMjEtMC45OTUsNy4yMTItMi45ODdsNTUuNzUzLTU1Ljc1M2MxNS4yMzQsNC4xOSwzMS4yNjMsNi40NDEsNDcuODA5LDYuNDQxDQoJYzE3LjE0NSwwLDMzLjczOC0yLjQwNSw0OS40NjEtNi44OTNsNTYuMjA1LDU2LjIwNWMxLjk5MiwxLjk5Miw0LjYwMiwyLjk4Nyw3LjIxMiwyLjk4N3M1LjIyMS0wLjk5NSw3LjIxMi0yLjk4Nw0KCWMxNC43ODktMTQuNzg5LDIzLjgyOC0zNC40MDMsMjUuNDU0LTU1LjIyOWMxLjQ0NC0xOC41LTMuMDI0LTM2Ljk1Ny0xMi42MDktNTIuNjQzYzI0Ljg5OS0yNy4xMzQsNDEuNjE3LTYxLjg4Myw0Ni4yMTgtMTAwLjMwNg0KCWg2Ni42NDljNS42MzMsMCwxMC4xOTktNC41NjYsMTAuMTk5LTEwLjE5OUM1MTIsMjQwLjE2LDQ3Mi42MDQsMjAwLjc2Myw0MjQuMTgsMjAwLjc2M3ogTTIxNC40NTIsNjQNCgljMC0yMi45MDksMTguNjM4LTQxLjU0OCw0MS41NDgtNDEuNTQ4YzIyLjkxLDAsNDEuNTQ4LDE4LjYzOCw0MS41NDgsNDEuNTQ4djM3LjU4N2MtMTMuMzQ1LTMuMTU3LTI3LjI1My00LjgzNS00MS41NDgtNC44MzUNCgljLTE0LjI5NSwwLTI4LjIwNCwxLjY3OS00MS41NDgsNC44MzVWNjR6IE0yMS4xNjgsMjc4LjM4NGM0Ljc2NS0zMS4yNjYsMzEuMDg2LTU1LjUzNyw2My4yNzMtNTcuMTM0DQoJYy01Ljc2MiwxNy42MjMtOC44OTEsMzYuNDI2LTguODkxLDU1Ljk0OWMwLDAuMzk3LDAuMDEyLDAuNzg5LDAuMDE1LDEuMTg1TDIxLjE2OCwyNzguMzg0TDIxLjE2OCwyNzguMzg0eiBNMTIxLjYxOCwxOTAuMzYNCglsMjIuNjM3LDIyLjYzN2MxLjk5MiwxLjk5Miw0LjYwMiwyLjk4Nyw3LjIxMiwyLjk4N2MyLjYxLDAsNS4yMjEtMC45OTUsNy4yMTItMi45ODdjMy45ODMtMy45ODMsMy45ODMtMTAuNDQxLDAtMTQuNDI1DQoJbC0yNC43NTYtMjQuNzU2YzI5LjM4MS0zNC42NDEsNzMuMjAxLTU2LjY2OSwxMjIuMDc1LTU2LjY2OXM5Mi42OTQsMjIuMDI4LDEyMi4wNzUsNTYuNjY5bC00Mi45MDksNDIuOTA5bC02OC45NjYtMzkuODE3di0xMS40ODQNCgljMC01LjYzMy00LjU2Ni0xMC4xOTktMTAuMTk5LTEwLjE5OXMtMTAuMTk5LDQuNTY2LTEwLjE5OSwxMC4xOTl2MTEuNDg0bC03Ni42NTUsNDQuMjU3Yy0zLjE1NiwxLjgyMi01LjEsNS4xODgtNS4xLDguODMzdjg4LjUwOA0KCWwtNDMuNjM1LDQzLjYzNWMtMTUuNDg3LTI0LjYzNC0yNC40NjItNTMuNzU3LTI0LjQ2Mi04NC45NDJDOTUuOTUsMjQ1LjIxMSwxMDUuMzg4LDIxNS4zOSwxMjEuNjE4LDE5MC4zNnogTTI2Ny4yMzQsNDM2Ljg0OQ0KCXYtNTkuOTU3bDY5LjI0NC0zOS45NzlsNDIuNTQ1LDQyLjU0NUMzNTEuODg4LDQxMi4wNDksMzEyLjA3Nyw0MzMuNzI0LDI2Ny4yMzQsNDM2Ljg0OXogTTEzMi41MDMsMzc4Ljg5N2w0Mi4zNjItNDIuMzYyDQoJbDcxLjk3LDQxLjU1MnY1OC44OTNDMjAwLjg4OSw0MzQuMzc0LDE2MC4wNjIsNDEyLjMwNSwxMzIuNTAzLDM3OC44OTd6IE0yNTYsMTk0LjU3NGw3MS41NTYsNDEuMzEzdjgyLjYyNUwyNTYsMzU5LjgyNQ0KCWwtNzEuNTU2LTQxLjMxM3YtODIuNjI1TDI1NiwxOTQuNTc0eiBNMTQ1Ljc2Myw0ODQuNzg2Yy0xNS4wMDktMjAuMzI0LTE3LjM1OS00Ny4yNDgtNi4xMzYtNjkuNzk3DQoJYzE0LjAzNiwxMS44NzMsMjkuODk5LDIxLjY0Niw0Ny4xMDcsMjguODI2TDE0NS43NjMsNDg0Ljc4NnogTTM2OC4zNDEsNDg0Ljc4OGwtNDEuNTk0LTQxLjU5NA0KCWMxNy4yMzMtNy4zNzMsMzMuMDk1LTE3LjM1LDQ3LjA4Ny0yOS40MzlDMzg1Ljc3Myw0MzYuNTUsMzgzLjYyNyw0NjQuMDksMzY4LjM0MSw0ODQuNzg4eiBNMzkxLjE5LDM2Mi43NzdsLTQzLjIzNi00My4yMzZ2LTg2Ljc1Mw0KCWw0Mi40MjgtNDIuNDI4YzE2LjIzLDI1LjAyOSwyNS42NjgsNTQuODUxLDI1LjY2OCw4Ni44MzlDNDE2LjA1LDMwOC42NTIsNDA2LjkyNSwzMzguMDExLDM5MS4xOSwzNjIuNzc3eiBNNDM2LjQzNCwyNzguMzg0DQoJYzAuMDAzLTAuMzk2LDAuMDE1LTAuNzg5LDAuMDE1LTEuMTg1YzAtMTkuNTIyLTMuMTI5LTM4LjMyNi04Ljg5MS01NS45NDljMzIuMTg3LDEuNTk3LDU4LjUwOCwyNS44NjksNjMuMjczLDU3LjEzNEg0MzYuNDM0eiIvPg0KPHBhdGggZD0iTTI1NiwxNDcuNjhjNS42MzMsMCwxMC4xOTktNC41NjYsMTAuMTk5LTEwLjE5OXYtMi4wN2MwLTUuNjMzLTQuNTY2LTEwLjE5OS0xMC4xOTktMTAuMTk5cy0xMC4xOTksNC41NjYtMTAuMTk5LDEwLjE5OQ0KCXYyLjA3QzI0NS44MDEsMTQzLjExNCwyNTAuMzY3LDE0Ny42OCwyNTYsMTQ3LjY4eiIvPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPC9zdmc+DQo=" type="image/svg+xml" />
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
            <script src="js/request.js"></script>
            <script>
                const addNewShopTurtle = `<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:a="http://ns.adobe.com/AdobeSVGViewerExtensions/3.0/" x="0px" y="0px" width="183.9px" height="182.4px" viewBox="0 0 183.9 182.4" style="enable-background:new 0 0 183.9 182.4;" xml:space="preserve"><style type="text/css">.st0{fill:#8CC63F;}.st1{fill:#FF931E;}.st2{fill:#F15A24;stroke:#000000;stroke-width:7;}</style><defs></defs><g><path class="st0" d="M2.5,102.9C2.5,87.5,15,75,30.4,75s27.9,12.5,27.9,27.9H2.5z"/><path class="st0" d="M123.4,102.9c0-15.4,12.5-27.9,27.9-27.9s27.9,12.5,27.9,27.9H123.4z"/><path class="st0" d="M92,139.3c10.9-10.9,28.5-10.9,39.4,0c10.9,10.9,10.9,28.5,0,39.4L92,139.3z"/><path class="st0" d="M90.5,139.3c-10.9-10.9-28.5-10.9-39.4,0s-10.9,28.5,0,39.4L90.5,139.3z"/><path class="st0" d="M109.4,62H72.3V22.3c0-10.3,8.3-18.6,18.6-18.6l0,0c10.3,0,18.6,8.3,18.6,18.6V62z"/></g><circle class="st1" cx="90.8" cy="98.8" r="61.2"/><path d="M152.4,71.4c-0.6,0-1.1,0-1.7,0c-7.2-15.4-20.4-27.6-36.5-33.5V22.3C114.2,10,104.2,0,92,0S69.7,10,69.7,22.3V38 c-16.1,5.9-29.2,18-36.5,33.5c-0.6,0-1.1,0-1.7,0C14.2,71.4,0,85.5,0,102.9c0,2,1.6,3.7,3.7,3.7h23.9c1.7,14,7.9,26.7,17.1,36.5 c-3.2,5.5-4.7,12-4.2,18.4c0.6,7.5,3.8,14.5,9.1,19.8c0.7,0.7,1.7,1.1,2.6,1.1s1.9-0.4,2.6-1.1l20-20c5.5,1.5,11.2,2.3,17.2,2.3 c6.2,0,12.1-0.9,17.8-2.5l20.2,20.2c0.7,0.7,1.7,1.1,2.6,1.1c0.9,0,1.9-0.4,2.6-1.1c5.3-5.3,8.6-12.4,9.1-19.8	c0.5-6.6-1.1-13.3-4.5-18.9c8.9-9.7,14.9-22.2,16.6-36h23.9c2,0,3.7-1.6,3.7-3.7C183.9,85.5,169.8,71.4,152.4,71.4z M77,22.3 C77,14,83.7,7.3,92,7.3s14.9,6.7,14.9,14.9v13.5C102.1,34.6,97.1,34,92,34c-5.1,0-10.1,0.6-14.9,1.7V22.3z M7.6,99.3 C9.3,88,18.8,79.3,30.3,78.7c-2.1,6.3-3.2,13.1-3.2,20.1c0,0.1,0,0.3,0,0.4H7.6L7.6,99.3z M96,156.2v-21.5l24.9-14.4l15.3,15.3 C126.4,147.3,112.1,155.1,96,156.2z M47.6,135.4l15.2-15.2l25.9,14.9v21.2C72.2,155.3,57.5,147.4,47.6,135.4z M92,69.2L117.7,84 v29.7L92,128.5l-25.7-14.8V84L92,69.2z M52.4,173.4c-5.4-7.3-6.2-17-2.2-25.1c5,4.3,10.7,7.8,16.9,10.4L52.4,173.4z M132.3,173.4 l-14.9-14.9c6.2-2.6,11.9-6.2,16.9-10.6C138.6,156.1,137.8,166,132.3,173.4z M58.9,113.7l-15.7,15.7c-5.6-8.8-8.8-19.3-8.8-30.5 c0-11.5,3.4-22.2,9.2-31.2l8.1,8.1c0.7,0.7,1.7,1.1,2.6,1.1c0.9,0,1.9-0.4,2.6-1.1c1.4-1.4,1.4-3.8,0-5.2l-8.9-8.9 C58.7,49.3,74.4,41.3,92,41.3s33.3,7.9,43.8,20.4l-15.4,15.4l4.6,5.8l15.2-15.2c5.8,9,9.2,19.7,9.2,31.2c0,11.3-3.3,21.8-8.9,30.7 L125,114 M156.8,99.3c0-0.1,0-0.3,0-0.4c0-7-1.1-13.8-3.2-20.1c11.6,0.6,21,9.3,22.7,20.5H156.8z"/><path d="M90.8,52.3c2,0,3.7-1.6,3.7-3.7v-0.7c0-2-1.6-3.7-3.7-3.7s-3.7,1.6-3.7,3.7v0.7C87.2,50.7,88.8,52.3,90.8,52.3z"/><ellipse class="st1" cx="92" cy="98.8" rx="57.5" ry="57.4"/><g><path class="st2" d="M104.3,110.7v26.8H77.4c0,0-0.5-10.5-0.8-22.4l-22.4,4.2c-3.4-11.3-5.5-23.2-6.3-28.2 c4.2-1.1,15.3-2.9,28.7-4.7c0-10,1.8-20,3.2-30c0,0,20.8,1.3,26.1,2.4c0,0-1.1,12.9-1.6,24.2c9.2-1.3,18.4-2.1,25.3-2.6 c0,0,2.6,17.4,2.1,26.1C131.7,106.5,119.3,108.3,104.3,110.7z"/></g></svg>`
            </script>
            <style>
                .logo img{
                    height: 200px;
                    width: 200px;
                }
                .listing-id {
                    float: left;
                    overflow: auto;
                }

                .get-listing {
                    width: 100%;
                    display: block;
                }

                .shop {
                    clear: both;
                }

                .listing-id div {
                    text-align: center;
                }
                
            </style>
        </head>
        <body>
            <script>
                (async function boot(){
                    try{
                        window.history.pushState({ page : 'demo' }, 'Demo', '/')
                        let result = await getSessionTenantShops()
                        $('body').append('<div class="all-shops"></div>')
                        if(result.count > 0){
                            console.log(result.tenantShops)
                            let tenantShops = result.tenantShops
                            $.each(tenantShops, function(shopIndex,shop){
                                console.log(shop)
                                $('.all-shops').append('<div class="shop" id="' + shop.user_id + '" data-shop-id=' + shop.shop_id + '></div>')
                                let $shop = $('.shop').last()
                                $shop
                                    .append('<div class="logo"><img src="' + shop.icon_url_fullxfull + '"/></div>')
                                    .append('<div class="do-stuff"></div>')
                                    $shop.find('.do-stuff')
                                        .append('<a href class="get-shop-balance">Get Shop Balance</a>')
                                        .append('<form method="post" action="" enctype="multipart/form-data" id="myform"><input type="file" class="file" name="file[]" multiple/><input type="button" class="button upload" value="Upload"></form>')
                                        .append('<a href class="get-listing" data-index="0">Load a Listing</a>')
                                        .append('<p><a href class="get-seller-taxonomy-nodes">Get Seller Taxonomy Nodes (501)</a></p>')
                                        .append('<p><a href class="get-properties-by-taxonomy-id">Get Properties By Taxonomy Id</a></p>')
                                        .append('<div class="test-popups"><a href>CLICK TO TEST/ENABLE POP-UPS FIRST!!</a></div>')
                                        .append('<div class="get-inactive-listings"><a href>Get Inactive Listings</a></div>')
                                        .append('<div class="get-listing-inventory"><a href>Get Listing Inventory</a></div>')
                                        .append('<div class="change-listing-title"><a href>Change Listing Title</a></div>')
                            })
                            $('.change-listing-title').click(async function(e){
                                e.preventDefault()
                                try{
                                    let user_id = $(this).parents('.shop').attr('id')
                                    let listingID = prompt('Enter listingID')
                                    //let price = prompt('price')
                                    let shop_id = parseInt($(this).parents('.shop').attr('data-shop-id'))

                                    let request = {
                                            endpoint : 'updateListing',
                                            parameters : {
                                                shop_id : shop_id,
                                                listing_id : listingID,
                                                state: [ 'inactive' ],
                                                //item_length : 3,
                                                //item_width: 4,
                                                //item_height: .188,
                                                //item_dimensions_unit: "in",
                                            },
                                        }

                                    let result = await private(user_id, request)
                                    console.log(result)
                                }
                                catch(e){
                                    console.log(e)
                                    alert('failed to update listing title')
                                }

                            })
                            $('.test-popups').click(function(e){
                                alert('If no popup window appears after this alert window, you will need to enable popup windows for this webpage. If you do not know how to enable pop-ups - checkout this link:  https://support.google.com/chrome/answer/95472')
                                let popTest = window.open('','Pop-up Test')
                                popTest.document.write("Success!  You may close this window and proceed")
                            })
                            $('.get-shop-balance').click(async function(e){
                                try{
                                    e.preventDefault()
                                    let user_id = $(this).parents('.shop').attr('id')
                                    let result = await getShopBalance(user_id)
                                    alert('Your shop balance is $' + result)
                                }
                                catch(e) {
                                    alert('Unable to get Shop Balance')
                                }
                                
                            })
                            $('.upload').click(async function(e){
                                try{
                                    e.preventDefault()
                                    var files = $(this).parents('form').find('.file')[0].files
                                    let shop_id = parseInt($(this).parents('.shop').attr('data-shop-id'))
                                    
                                    // Check file selected or not
                                    if(files.length > 0 ){
                                        let listing_id = parseInt(prompt('Enter listing_id value:'))
                                        if(listing_id == undefined || listing_id == '')throw JSON.stringify({error : "listing_id not supplied"})
                                        if(isNaN(parseInt(listing_id)))throw JSON.stringify({error : 'invalid listing_id'})
                                        let rank = parseInt(prompt('Enter image rank'))
                                        if(rank < 1 || isNaN(rank))throw JSON.stringify({error: 'Invalid rank, please enter integer greater than 0'})
                                        // !! --->> user_id <<--- !! \\
                                        let user_id = $(this).parents('.shop').attr('id')

                                        // !! --->> uploadListingImage <<--- !! \\
                                        let request = {
                                            endpoint : 'uploadListingImage',
                                            parameters : {
                                                shop_id : shop_id,
                                                listing_id : listing_id,
                                            },
                                            bodyParameters : {
                                                rank : rank,
                                            },
                                        }

                                        // !! --->> FormData <<--- !! \\
                                        let formData = new FormData()
                                        Array.from({ length : files.length}).forEach((o,i) => {
                                            formData.append('image', files[i])
                                        });
                                        formData.append('rank', 2)
                                        formData.append('overwrite', false)
                                        formData.append('is_watermarked', false)

                                        // !! --->> PRIVATE REQUEST with FormData <<--- !! \\
                                        let result = await private(user_id, request, formData)

                                    }else{
                                    alert("Please select a file.");
                                    }
                                }
                                catch(e){
                                    alert(JSON.parse(e).error)
                                    console.log(e)
                                }
                            });
                            $('.get-listing').click(async function(e){
                                e.preventDefault()
                                let listingIndexToLoad = $(this).data('index')
                                let shop_id = parseInt($(this).parents('.shop').attr('data-shop-id'))
                                console.log(shop_id)
                                // !! ---> findAllActiveListingsByShop <--- !! \\
                                let request = {
                                    endpoint: 'findAllActiveListingsByShop',
                                    parameters : {
                                        shop_id : shop_id,
                                        limit : 1,
                                        offset : listingIndexToLoad
                                    }
                                }
                                $(this).data('index',++listingIndexToLoad)

                                // !! ---> PUBLIC REQUEST <--- !! \\
                                let { results : listings } = await public(request)
                                let listing = listings[0]

                                // !! ---> getListingImages <--- !! \\
                                let imagesRequest = {
                                    endpoint: 'getListingImages',
                                    parameters : {
                                        shop_id : shop_id,
                                        listing_id : listing.listing_id
                                    }
                                }

                                // !! ---> PUBLIC REQUEST <--- !! \\
                                let { results : listingImageResults } = await public(imagesRequest)

                                let firstImage_url_170x135 = listingImageResults[0].url_170x135
                                $(this).after('<div class="listing-id"  id="' + listing.listing_id + '"></div>')
                                $('#' + listing.listing_id)
                                    .append('<a href="' + listing.url + '"" target="_blank"><img src="' + firstImage_url_170x135 + '"></a>')
                                    .append('<div>' + listing.listing_id + '</div>')
                                    .append('<div><a href class="update-qty">Update Listing Quantity</a></div>')
                                $(this).text('Load another listing')

                                $('#' + listing.listing_id).find('.update-qty').click(async function(e){
                                    try{
                                        e.preventDefault()
                                        let updateQty = parseInt(prompt('Enter new listing quantity:'))
                                        if(updateQty < 0 || isNaN(updateQty))throw 'Enter valid quantity'

                                        let user_id = $(this).parents('.shop').attr('id')

                                        let request = {
                                            endpoint : 'updateListing',
                                            parameters : {
                                                listing_id : listing.listing_id,
                                                quantity : updateQty,
                                            }
                                        }

                                        let results = private(user_id, request)
                                        console.log(results)

                                    }
                                    catch(e){
                                        alert('error, see console'),
                                        console.log(e)
                                    }
                                })
                            })
                            $('.get-seller-taxonomy-nodes').click(async function(e){
                                try{
                                    e.preventDefault()
                                    let request = {
                                        endpoint: 'getSellerTaxonomyNodes'
                                    }

                                    let result = await public(request)
                                    console.log(result)
                                }
                                catch(e) {
                                    console.log(e)
                                }
                                
                            })
                            $('.get-properties-by-taxonomy-id').click(async function(e){
                                try{
                                    e.preventDefault()
                                    let taxonomy_id = parseInt(prompt('Enter Taxonomy ID To Explore'))
                                    if(isNaN(taxonomy_id) || taxonomy_id < 1)throw 'Invalid ID Value'
                                    let request = {
                                        endpoint : 'getPropertiesByTaxonomyId',
                                        parameters : {
                                            taxonomy_id : taxonomy_id,
                                        },
                                    }
                                    let result = await public(request)
                                    alert('See console')
                                    console.log(result)
                                }
                                catch(e) {
                                    console.log(e)
                                }
                            })
                            $('.get-inactive-listings a').click(async function(e){
                                try{
                                    e.preventDefault()
                                    $getListings = $(this)
                                    let shop_id = parseInt($(this).parents('.shop').attr('data-shop-id'))
                                    $getListings.css("pointer-events", "none").text('Finding inactive listings...')
                                    //let limit = parseInt(prompt('How many listings to load?'))
                                    //if(isNaN(limit) || limit < 1)throw 'Invalid quantity'

                                    let user_id =  $getListings.parents('.shop').attr('id')

                                    let request = {
                                        endpoint : 'getListingsByShop',
                                        parameters : {
                                            shop_id : shop_id,
                                            state : 'inactive',
                                            limit : 50,
                                        },
                                    }
                                    
                                    let offset = 0

                                    let { results : listings , count } = await private(user_id,request)
                                    $getListings.append('<div>Found ' + count + ' inactive listings</div>')
                                    console.log(count)
                                    //count = 150
                                    function findMoreListings(resolve2,reject2){
                                        return new Promise (async (resolve, reject) => {
                                            try{
                                                $getListings.append('<div>Retrieving basic listing data...</div>')
                                                console.log('finding more listings')
                                                async function asyncFindListings(resolve,reject){
                                                    try{
                                                        if(offset + 50 < count ){
                                                            offset += 50
                                                            console.log(offset)
                                                            let request = {
                                                                endpoint : 'getListingsByShop',
                                                                parameters : {
                                                                    shop_id : shop_id,
                                                                    state : 'inactive',
                                                                    limit : 50,
                                                                    offset : offset,
                                                                },
                                                            }
                                                            $getListings.find('div').last().text($getListings.find('div').last().text() + '...')
                                                            let { results : moreListings } = await private(user_id,request)
                                                            listings = [...listings, ...moreListings]
                                                            asyncFindListings(resolve,reject)
                                                        }
                                                        else {
                                                            console.log(listings)
                                                            resolve()
                                                            console.log('postresolve')
                                                            return
                                                        }
                                                    }
                                                    catch(e){
                                                        console.log(e)
                                                    }
                                                    
                                                }
                                                asyncFindListings(resolve,reject)
                                                
                                            }
                                            catch (e) {
                                                console.log('error')
                                                console.log(e)
                                                reject(e)
                                            }
                                        })
                                        
                                    }
                                    if(count > 50)await findMoreListings()
                                    $getListings.append('<div>Done loading listing data.</div>')
                                    $getListings.append('<div>Collecting listing image data...</div>')
                                    console.log('donefindinglistings')
                                    console.log('listings',listings)
                                    listings = await serializeRequests(getListingImages,listings,$getListings)
                                    console.log('imageResults', listings)
                                    $getListings.append('<div>Done loading image data.</div>')
                                    $getListings.append('<div>Collecting listing variation data...</div>')
                                    let inventoryResults = await serializeRequests(getListingInventory,listings,$getListings)
                                    console.log('inventoryResults',inventoryResults)
                                    let exportArray = []
                                    let masterArray = []
                                    const headers = [ 'TITLE', 'DESCRIPTION','PRICE', 'CURRENCY', 'QUANTITY', 'TAGS', 'MATERIALS', 'IMAGE1', 'IMAGE2', 'IMAGE3', 'IMAGE4', 'IMAGE5', 'IMAGE6', 'IMAGE7', 'IMAGE8', 'IMAGE9', 'IMAGE10', 'VARIATION 1 TYPE', 'VARIATION 1 NAME', 'VARIATION 1 VALUES', 'VARIATION 2 TYPE', 'VARIATION 2 NAME', 'VARIATION 2 VALUES', 'SKU']
                                    masterArray.push(headers)
                                    $.each(listings, function(listingIndex,listing){
                                        let dataArray = []
                                        dataArray.push('"' + listing.title.replaceAll('"','""').replaceAll('&#39;','\'').replaceAll('&quot;','""') + '"')
                                        dataArray.push('"' + listing.description.replaceAll('"','""').replaceAll('&#39;','\'').replaceAll('&quot;','""') + '"')
                                        dataArray.push(listing.price.amount.toFixed(2)/100)
                                        dataArray.push(listing.price.currency_code)
                                        dataArray.push(listing.quantity)
                                        dataArray.push('"' + listing.tags.join().replaceAll('"','""').replaceAll('&#39;','\'').replaceAll('&quot;','""') + '"')
                                        dataArray.push('"' + listing.materials.join().replaceAll('"','""').replaceAll('&#39;','\'').replaceAll('&quot;','""') + '"')
                                        dataArray.push(listing.listingImages[0].url_fullxfull)
                                        if(listing.listingImages[1] != undefined){
                                            dataArray.push(listing.listingImages[1].url_fullxfull)
                                        }
                                        else{
                                            dataArray.push('')
                                        }
                                        if(listing.listingImages[2] != undefined){
                                            dataArray.push(listing.listingImages[2].url_fullxfull)
                                        }
                                        else{
                                            dataArray.push('')
                                        }
                                        if(listing.listingImages[3] != undefined){
                                            dataArray.push(listing.listingImages[3].url_fullxfull)
                                        }
                                        else{
                                            dataArray.push('')
                                        }
                                        if(listing.listingImages[4] != undefined){
                                            dataArray.push(listing.listingImages[4].url_fullxfull)
                                        }
                                        else{
                                            dataArray.push('')
                                        }
                                        if(listing.listingImages[5] != undefined){
                                            dataArray.push(listing.listingImages[5].url_fullxfull)
                                        }
                                        else{
                                            dataArray.push('')
                                        }
                                        if(listing.listingImages[6] != undefined){
                                            dataArray.push(listing.listingImages[6].url_fullxfull)
                                        }
                                        else{
                                            dataArray.push('')
                                        }
                                        if(listing.listingImages[7] != undefined){
                                            dataArray.push(listing.listingImages[7].url_fullxfull)
                                        }
                                        else{
                                            dataArray.push('')
                                        }
                                        if(listing.listingImages[8] != undefined){
                                            dataArray.push(listing.listingImages[8].url_fullxfull)
                                        }
                                        else{
                                            dataArray.push('')
                                        }
                                        if(listing.listingImages[9] != undefined){
                                            dataArray.push(listing.listingImages[9].url_fullxfull)
                                        }
                                        else{
                                            dataArray.push('')
                                        }
                                        let variations = []
                                        if(listing.inventory[0].property_values.length > 0){
                                            $.each(listing.inventory, function(inventoryIndex,inventory){
                                                $.each(inventory.property_values, function (propValIndex,propVal){
                                                    let property_id = inventory.property_values[propValIndex].property_id
                                                    let property_name = inventory.property_values[propValIndex].property_name
                                                    let values = inventory.property_values[propValIndex].values
                                                    let findInventory = variations.find(o => { return o.property_id == property_id })
                                                if(findInventory == undefined){
                                                    let variation = { property_id : property_id , property_name : property_name , values : values }
                                                    variations.push(variation)                                                
                                                }
                                                else{
                                                    if(findInventory.values.indexOf(...values) == -1){
                                                        findInventory.values = [...findInventory.values, ...values]
                                                    }
                                                }
                                                })
                                                
                                            })
                                            dataArray.push(variations[0].property_id)
                                            dataArray.push(variations[0].property_name)
                                            dataArray.push('"' + variations[0].values.join().replaceAll('"','""').replaceAll('&#39;','\'').replaceAll('&quot;','""') + '"')
                                            if(variations.length == 2){
                                                dataArray.push(variations[1].property_id)
                                                dataArray.push(variations[1].property_name)
                                                dataArray.push('"' + variations[1].values.join().replaceAll('"','""').replaceAll('&#39;','\'').replaceAll('&quot;','""') + '"')
                                            }
                                            else{
                                                dataArray.push('')
                                                dataArray.push('')
                                                dataArray.push('')    
                                            }
                                        }
                                        else{
                                            dataArray.push('')
                                            dataArray.push('')
                                            dataArray.push('')
                                            dataArray.push('')
                                            dataArray.push('')
                                            dataArray.push('')
                                        }
                                        /*if(listing.inventory[0] != undefined){
                                            if(listing.inventory[0].property_values[0] != undefined){
                                                dataArray.push(listing.inventory[0].property_values[0].property_id)
                                                dataArray.push(listing.inventory[0].property_values[0].property_name)
                                                if(listing.inventory[0].property_values[0].values.length > 0){
                                                    console.log('listinglisting',listing)
                                                    dataArray.push('"' + listing.inventory[0].property_values[0].values.join() + '"')
                                                }
                                                else{
                                                    dataArray.push('')
                                                }
                                            }
                                            else{
                                                dataArray.push('')
                                                dataArray.push('')
                                                dataArray.push('')
                                            }
                                        }
                                        else{
                                            dataArray.push('')
                                            dataArray.push('')
                                            dataArray.push('')
                                        }
                                        if(listing.inventory[1] != undefined){
                                            if(listing.inventory[1].property_values[0] != undefined){
                                                dataArray.push(listing.inventory[1].property_values[0].property_id)
                                                dataArray.push(listing.inventory[1].property_values[0].property_name)
                                                if(listing.inventory[1].property_values[0].values.length > 0){
                                                    dataArray.push(listing.inventory[1].property_values[0].values.join())
                                                }
                                                else{
                                                    dataArray.push('')
                                                }
                                            }
                                            else{
                                                dataArray.push('')
                                                dataArray.push('')
                                                dataArray.push('')
                                            }
                                        }
                                        else{
                                            dataArray.push('')
                                            dataArray.push('')
                                            dataArray.push('')
                                        }
                                        */
                                        if(listing.inventory[0] != undefined){
                                            dataArray.push('"' + listing.inventory[0].sku.replaceAll('"','""').replaceAll('&#39;','\'').replaceAll('&quot;','""') + '"')
                                        }
                                        else{
                                            dataArray.push('')
                                        }
                                        masterArray.push(dataArray)
                                    })
                                    const rows = [
                                        ["name1", "city1", "some other info"],
                                        ["name2", "city2", "more info"]
                                    ];

                                    let csvContent = "data:text/csv;charset=utf-8,"

                                    masterArray.forEach(function(rowArray) {
                                        let row = rowArray.join(",")
                                        csvContent += row + "\r\n"
                                    });

                                    var encodedUri = encodeURI(csvContent).replaceAll('#', '%23')
                                    console.log(csvContent)
                                    //var str = "Name, Price\nApple, 2\nOrange, 3";
                                    //var uri = 'data:text/csv;charset=utf-8,' + str;

                                    var downloadLink = document.createElement("a")
                                    downloadLink.href = encodedUri;
                                    downloadLink.download = "data.csv";

                                    document.body.appendChild(downloadLink);
                                    downloadLink.click();
                                    document.body.removeChild(downloadLink)
                                    //window.open(encodedUri);
                                    //let listingPropertyResults = await serializeRequests(getListingProperties,inventoryResults)
                                    //console.log('propertyResults', listingPropertyResults)
                                    /*$.each(imageResults, function (imageArrayIndex,imageArray){
                                        let firstImage_url_170x135 = imageArray[0].url_170x135
                                        $getListings.parent().append('<div class="listing"><img src="' + firstImage_url_170x135 + '"></div>')
                                    })*/
                                    $getListings.append('<div>Done.</div>').css("pointer-events", "auto")
                                    alert('Your download is complete')
                                    async function getListingImages(listing){
                                        try{
                                            let imagesRequest = {
                                                endpoint: 'getListingImages',
                                                parameters : {
                                                    shop_id : shop_id,
                                                    listing_id : listing.listing_id
                                                }
                                            }
                                            let { results : listingImageResults } = await public(imagesRequest)
                                            listing.listingImages = listingImageResults
                                            return listing
                                        }
                                        catch(e){
                                            console.log(e)
                                            $getListings.text('Get Listings').css("pointer-events", "auto")
                                        }

                                    }

                                    async function getListingInventory(listing){
                                        try{
                                            let inventoryRequest = {
                                                endpoint: 'getListingInventory',
                                                parameters : {
                                                    listing_id : listing.listing_id
                                                }
                                            }
                                            let { products : listingInventoryResults } = await private(user_id, inventoryRequest)
                                            listing.inventory = listingInventoryResults
                                            console.log(listing)
                                            return listing
                                        }
                                        catch(e){
                                            console.log(e)
                                            $getListings.text('Get Listings').css("pointer-events", "auto")
                                        }

                                    }
                                    async function getListingProperties(listing){
                                        try{
                                            let propertyRequest = {
                                                endpoint: 'getListingProperties',
                                                parameters : {
                                                    shop_id : shop_id,
                                                    listing_id : listing.listing_id
                                                }
                                            }
                                            let { results : listingPropertyResults } = await private(user_id, propertyRequest)
                                            listing.properties = listingPropertyResults
                                            return listing
                                        }
                                        catch(e){
                                            console.log(e)
                                            $getListings.text('Get Listings').css("pointer-events", "auto")
                                        }

                                    }

                                    
                                }
                                catch(e){
                                    alert(e)
                                    $getListings.text('Get Listings').css("pointer-events", "auto")
                                }
                            })
                            $('.get-listing-inventory a').click(async function(e) {
                                try{
                                    e.preventDefault()
                                    $getListingInventory = $(this).parents('.get-listing-inventory')
                                    let listing_id = parseInt(prompt('Enter listing_id value:'))
                                    if(listing_id == undefined || listing_id == '')throw JSON.stringify({error : "listing_id not supplied"})
                                    if(isNaN(parseInt(listing_id)))throw JSON.stringify({error : 'invalid listing_id'})

                                    let user_id = $(this).parents('.shop').attr('id')

                                    let request = {
                                        endpoint : 'getListingInventory',
                                        parameters : {

                                            listing_id : listing_id,
                                        }
                                    }

                                    let result = await private(user_id,request)
                                    console.log(result)
                                    $getListingInventory.append('<a href class="blob">Data Blob</a>')
                                    $getListingInventory.find('.blob')
                                        .data(result)
                                        .click(function(e){
                                            e.preventDefault()
                                            alert('Blob attached to element data and logged in console')
                                            console.log(result)
                                        })
                                    $getListingInventory.append('<a href class="change-pricing">Change Pricing</a>')
                                    $getListingInventory.find('.change-pricing')
                                        .click(async function(e){
                                            e.preventDefault()
                                            $.each(result.products, function (productIndex,product){
                                                let productPrice = product.offerings[0].price.amount
                                                let newPrice = prompt('Enter new price for ' + product.property_values[0].values[0], productPrice)
                                                product.offerings[0].price.amount = newPrice
                                            })
                                            let request = { 
                                                endpoint : 'updateListingInventory',
                                                parameters : {
                                                    listing_id : listing_id,
                                                    products : result
                                                }
                                            }

                                            let result2 = await private(user_id,request)
                                            console.log(result2)
                                        })

                                }
                                catch (e) {
                                    alert(e)
                                    console.log(e)
                                }
                            })

                        }
                        (function addShops(){
                            $('.all-shops').append('<div id="add-shop" class="shop"></div>')
                            $('#add-shop').append('<a href="/auth-etsy" title="Add Shop">' + addNewShopTurtle + '</a>')
                        })();
                    }
                    catch(e) {
                        alert('Off to a great start, error, see console.')
                        console.log(e)
                    }                 
                })();

function serializeRequests(myFunction,dataArray,$guiDataPoint){
    return new Promise(async (resolve,reject) => {
        try{
            console.log('serializing requests')
            currentCount = 0
            $guiDataPoint.append('<div class="serialize">Retrieving: ' + currentCount + ' of ' + dataArray.length)
            //console.log('dataArray',dataArray)
            let rateLimiting = 110
            let arrIndex = 0
            let results = []
            if(arrIndex < dataArray.length){
                runFunction()
            }
            async function runFunction(){
                try{
                    let result = await myFunction(dataArray[arrIndex++])
                    results.push(result)
                    if(arrIndex < dataArray.length){
                        setTimeout(() => {
                            $guiDataPoint.find('.serialize').last().text((arrIndex + 1) + ' of ' + dataArray.length)
                            runFunction()
                        }, rateLimiting);
                        
                    }
                    else{
                        resolve(results)
                    }
                }
                catch(e){
                    throw e
                }
            }
        }
        catch(e) {
            reject(e)
        }
    })
}

/*
        dataArray.forEach(element => {
            setTimeout(async () => {
                let result = await myFunction(element)
                timeout += 110
            }, timeout)
        })   
        */



/*                function private(user_id,request,formData) {
                    return new Promise((resolve,reject)=>{
                        let ajaxRequest = {
                            url: '/private/' + user_id + '/req/' + btoa(JSON.stringify(request)),
                            type: 'POST',
                            dataType: 'json',
                            contentType: false,
                            processData: false,
                            success: function(responseText){
                                resolve(responseText)
                            },
                            error: function(error){
                                reject(error.responseText)
                            }
                        }
                        if(formData != undefined && formData != null)ajaxRequest.data = formData
                        $.ajax(ajaxRequest)
                    })
                }

                function public(request) {
                    return new Promise((resolve,reject)=>{
                        $.ajax({
                            url: '/public/req/' + btoa(JSON.stringify(request)),
                            type: 'GET',
                            dataType: 'json',
                            success: function(responseText){
                                resolve(responseText)
                            },
                            error: function(error){
                                reject(error.responseText)
                            }
                        })
                    })
                }*/

            </script>
        </body>
</html>
